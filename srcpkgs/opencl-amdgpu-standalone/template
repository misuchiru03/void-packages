# Template file for 'opencl-amdgpu-standalone'
pkgname=opencl-amdgpu-standalone
_major=19.50
_minor=1011208
version=${_major}.${_minor}
revision=1
build_style=fetch
only_for_archs="x86_64"
restricted="yes"
hostmakedepends="wget"
makedepends="tar xz"
depends="ocl-icd libdrm"
short_desc="Proprietary standalone opencl stack for amdgpu"
maintainer="lemmi <lemmi@nerd2nerd.org>"
license="AMD-GPU-PRO"
homepage="https://amd.com"
distfiles="https://drivers.amd.com/drivers/linux/amdgpu-pro-${_major}-${_minor}-ubuntu-18.04.tar.xz"
checksum=99a964a9151242f48cf5e40c157dc5147eabc156d8074f9fa2e8de3e81e554de

fetch_cmd='wget --referer https://support.amd.com/en-us/kb-articles/Pages/AMDGPU-PRO-Driver-for-Linux-Release-Notes.aspx -N'

do_build() {
	local shared="opt/amdgpu-pro/lib/x86_64-linux-gnu"
	local srcdir="$wrksrc"
	local prefix="amdgpu-pro-"
	local postfix="-ubuntu-18.04"
	local major="$_major"
	local minor="$_minor"

	tar xf "${prefix}${major}-${minor}${postfix}.tar.xz"

    mkdir "${srcdir}/opencl"
    cd "${srcdir}/opencl"
    ar x "${srcdir}/${prefix}${major}-${minor}${postfix}/opencl-amdgpu-pro-icd_${major}-${minor}_amd64.deb"
    tar xJf data.tar.xz
    ar x "${srcdir}/${prefix}${major}-${minor}${postfix}/opencl-orca-amdgpu-pro-icd_${major}-${minor}_amd64.deb"
    tar xJf data.tar.xz
    cd ${shared}
    sed -i "s|libdrm_amdgpu|libdrm_amdgpo|g" libamdocl-orca64.so

    mkdir "${srcdir}/libdrm"
    cd "${srcdir}/libdrm"
    ar x "${srcdir}/${prefix}${major}-${minor}${postfix}/libdrm-amdgpu-amdgpu1_2.4.99-${minor}_amd64.deb"
    tar xJf data.tar.xz
    cd ${shared/amdgpu-pro/amdgpu}
    rm "libdrm_amdgpu.so.1"
    mv "libdrm_amdgpu.so.1.0.0" "libdrm_amdgpo.so.1.0.0"
    ln -s "libdrm_amdgpo.so.1.0.0" "libdrm_amdgpo.so.1"

}

do_install() {
	local shared="opt/amdgpu-pro/lib/x86_64-linux-gnu"
	local srcdir="${wrksrc}"
	local pkgdir="${DESTDIR}"

    mv "${srcdir}/opencl/etc" "${pkgdir}/"
    mkdir -p ${pkgdir}/usr/lib
    mv "${srcdir}/opencl/${shared}/libamdocl64.so" "${pkgdir}/usr/lib/"
    mv "${srcdir}/opencl/${shared}/libamdocl-orca64.so" "${pkgdir}/usr/lib/"
    mv "${srcdir}/opencl/${shared}/libamdocl12cl64.so" "${pkgdir}/usr/lib/"
    mv "${srcdir}/libdrm/${shared/amdgpu-pro/amdgpu}/libdrm_amdgpo.so.1.0.0" "${pkgdir}/usr/lib/"
    mv "${srcdir}/libdrm/${shared/amdgpu-pro/amdgpu}/libdrm_amdgpo.so.1" "${pkgdir}/usr/lib/"

    mkdir -p "${pkgdir}/opt/amdgpu/share/libdrm"
    cd "${pkgdir}/opt/amdgpu/share/libdrm"
    ln -s /usr/share/libdrm/amdgpu.ids amdgpu.ids
}
