# Template file for 'plex-media-server'
pkgname=plex-media-server
version=1.32.7.7571
revision=1
_suffix=13cdc68dc
archs="i686 x86_64 armv7 aarch64"
create_wrksrc=yes
hostmakedepends="tar xz"
depends="glibc libssl1.1 libcrypto1.1 libswresample libavutil libva gtest libswscale
 libavformat libdrm libpciaccess fmt libavfilter taglib miniupnpc editline libusb"
short_desc="Plex Media Server"
maintainer="Anachron <gith@cron.world>"
license="custom:Proprietary"
homepage="https://www.plex.tv/media-server-downloads"
restricted=yes
repository=nonfree
system_accounts="_plex"
python_version=2
# libc.so contained here resolves in common/shlibs to musl-1.1.24_7
noverifyrdeps=yes
# See https://support.plex.tv/articles/categories/plex-media-server/

case "$XBPS_TARGET_MACHINE" in
		i686*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_i386.deb"
			checksum="3909d4fb26a4b61a6e4443b9d6bb9db6f5d7d251d038cf036dfad7a057eae52d"
			;;
		x86_64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_amd64.deb"
			checksum="9f7582d29882f8c30ecd5abf73505d209b58fd86d87de0cc813edcd2c74d53b1"
			;;
		armv7*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_armhf.deb"
			checksum="f4369de69c11ec8aa8548d7c035ca136df97e9a0da6846de7bf629dfed69cb7e"
			;;
		aarch64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_arm64.deb"
			checksum="180159ddb1b131bca158728cd79cc5b6ad117c7fdfcdc67d93360587b865a333"
			;;
esac

nopie="yes"
nopie_files="/usr/lib/plexmediaserver/Plex DLNA Server"

make_dirs="/var/plexmediaserver 0755 _plex _plex"

do_extract() {
	fn="${distfiles##*/}"
	ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/${fn}"
	tar xf data.tar.xz
	mkdir -p etc/default usr/bin
	cp "${FILESDIR}/default" etc/default/plexmediaserver
	cp "${FILESDIR}/start_pms" usr/bin/start_pms
}

do_install() {
	vcopy etc /
	vcopy usr /
	vsv plex-media-server
	vlicense "${FILESDIR}/LICENSE"
}

