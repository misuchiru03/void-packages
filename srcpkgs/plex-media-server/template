# Template file for 'plex-media-server'
pkgname=plex-media-server
version=1.25.5.5492
revision=4
_suffix=12f6b8c83
archs="i686 x86_64 armv7 aarch64"
create_wrksrc=yes
hostmakedepends="tar xz"
short_desc="Plex Media Server"
maintainer="Anachron <gith@cron.world>"
license="custom:Proprietary"
homepage="https://www.plex.tv/media-server-downloads"
restricted=yes
repository=nonfree
system_accounts="_plex"
python_version=2
# See https://support.plex.tv/articles/categories/plex-media-server/

case "$XBPS_TARGET_MACHINE" in
		i686*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_i386.deb"
			checksum="d60718e7c83f9b521905b32b78d59461c1bc2b0f260373acf476bace96709f03"
			;;
		x86_64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_amd64.deb"
			checksum="f27f541579be52d3eba684a4b54edc8e00c8b2c4fd3e919b4e4d934467e7e3c2"
			;;
		armv7*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_armhf.deb"
			checksum="a16f66b37bb6a3dd149a3fd41d104dc8b34981f452b24fb0ea4205937dab02be"
			;;
		aarch64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_arm64.deb"
			checksum="f3ff6bf0630e7e7a2b2a9636d90cdd9cd5fb2768a3cafff705e6163e9b1e4a3d"
			;;
esac

nopie="yes"
nopie_files="/usr/lib/plexmediaserver/Plex DLNA Server"

make_dirs="/var/plexmediaserver 0755 _plex _plex"

do_extract() {
	fn="${distfiles##*/}"
	ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/${fn}"
	tar xf data.tar.xz
	cp "${FILESDIR}/default" etc/default/plexmediaserver
	cp "${FILESDIR}/start_pms" usr/bin/start_pms
	rm -r etc/{apt,init}
}

do_install() {
	vcopy etc /
	vcopy usr /
	vsv plex-media-server
	vlicense "${FILESDIR}/LICENSE"
}
