# Template file for 'plex-media-server'
pkgname=plex-media-server
version=1.31.3.6819
revision=1
_suffix=2ef591a4c
archs="i686 x86_64 armv7 aarch64"
create_wrksrc=yes
hostmakedepends="tar xz"
depends="glibc libssl1.1 libcrypto1.1 libswresample libavutil libva gtest libswscale
 libavformat libdrm libpciaccess fmt libavfilter taglib miniupnpc editline libusb"
short_desc="Plex Media Server"
maintainer="Anachron <gith@cron.world>"
license="custom:Proprietary"
homepage="https://www.plex.tv/media-server-downloads"
restricted=yes
repository=nonfree
system_accounts="_plex"
python_version=2
# libc.so contained here resolves in common/shlibs to musl-1.1.24_7
noverifyrdeps=yes
# See https://support.plex.tv/articles/categories/plex-media-server/

case "$XBPS_TARGET_MACHINE" in
		i686*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_i386.deb"
			checksum="e80246600e76a5395cb39213013bc38dca4ee23338289d889c077f7377128620"
			;;
		x86_64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_amd64.deb"
			checksum="3276baa320c6b5ba2550373af592c8a57707340d11ce525681a2a87b2e4a811e"
			;;
		armv7*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_armhf.deb"
			checksum="1e3c74839ea0c00ced8140ccff498d7f67c29796499c52ae36e26729c5e68394"
			;;
		aarch64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_arm64.deb"
			checksum="196cc4e7d87b54af777e181b59f7dfe21fa19f702c9b81427df3bf909738718b"
			;;
esac

nopie="yes"
nopie_files="/usr/lib/plexmediaserver/Plex DLNA Server"

make_dirs="/var/plexmediaserver 0755 _plex _plex"

do_extract() {
	fn="${distfiles##*/}"
	ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/${fn}"
	tar xf data.tar.xz
	mkdir -p etc/default usr/bin
	cp "${FILESDIR}/default" etc/default/plexmediaserver
	cp "${FILESDIR}/start_pms" usr/bin/start_pms
}

do_install() {
	vcopy etc /
	vcopy usr /
	vsv plex-media-server
	vlicense "${FILESDIR}/LICENSE"
}
