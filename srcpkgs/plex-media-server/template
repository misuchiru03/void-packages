# Template file for 'plex-media-server'
pkgname=plex-media-server
version=1.40.1.8227
revision=1
_suffix=c0dd5a73e
archs="i686 x86_64 armv7 aarch64"
create_wrksrc=yes
hostmakedepends="tar xz"
depends="glibc libssl1.1 libcrypto1.1 libswresample libavutil libva gtest libswscale
 libavformat libdrm libpciaccess fmt libavfilter taglib miniupnpc editline libusb"
short_desc="Plex Media Server"
maintainer="Anachron <gith@cron.world>"
license="custom:Proprietary"
homepage="https://www.plex.tv/media-server-downloads"
restricted=yes
repository=nonfree
system_accounts="_plex"
python_version=2
# libc.so contained here resolves in common/shlibs to musl-1.1.24_7
noverifyrdeps=yes
# See https://support.plex.tv/articles/categories/plex-media-server/

case "$XBPS_TARGET_MACHINE" in
		i686*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_i386.deb"
			checksum="278b1ef87d2e16fab154986038d164efb4992c264e8f04b2f5755860a7fbe1d2"
			;;
		x86_64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_amd64.deb"
			checksum="a1d08917b81d436135244f10f87773caf6cc349ebb9379a0bbd20acfb72b5d0f"
			;;
		armv7*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_armhf.deb"
			checksum="57c54a376a46b74073a8977be7483ecd76b3546fca1edff9230863cc7aef2fc4"
			;;
		aarch64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_arm64.deb"
			checksum="e8ff9894d00bd1c840a75ce8abdecf2182650f4bba0f2374a2a327b1b843ec99"
			;;
esac

nopie="yes"
nopie_files="/usr/lib/plexmediaserver/Plex DLNA Server"

make_dirs="/var/plexmediaserver 0755 _plex _plex"

do_extract() {
	fn="${distfiles##*/}"
	ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/${fn}"
	tar xf data.tar.xz
	mkdir -p etc/default usr/bin
	cp "${FILESDIR}/default" etc/default/plexmediaserver
	cp "${FILESDIR}/start_pms" usr/bin/start_pms
}

do_install() {
	vcopy etc /
	vcopy usr /
	vsv plex-media-server
	vlicense "${FILESDIR}/LICENSE"
}
