# Template file for 'plex-media-server'
pkgname=plex-media-server
version=1.31.3.6868
revision=1
_suffix=28fc46b27
archs="i686 x86_64 armv7 aarch64"
create_wrksrc=yes
hostmakedepends="tar xz"
depends="glibc libssl1.1 libcrypto1.1 libswresample libavutil libva gtest libswscale
 libavformat libdrm libpciaccess fmt libavfilter taglib miniupnpc editline libusb"
short_desc="Plex Media Server"
maintainer="Anachron <gith@cron.world>"
license="custom:Proprietary"
homepage="https://www.plex.tv/media-server-downloads"
restricted=yes
repository=nonfree
system_accounts="_plex"
python_version=2
# libc.so contained here resolves in common/shlibs to musl-1.1.24_7
noverifyrdeps=yes
# See https://support.plex.tv/articles/categories/plex-media-server/

case "$XBPS_TARGET_MACHINE" in
		i686*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_i386.deb"
			checksum="2b75bdf017fd369fad9117edfac7adb17b7b84e0671a8093a519b8a6e94b0b98"
			;;
		x86_64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_amd64.deb"
			checksum="b3ebb8c0e2cadb7262c5452372eb641db12039ad9a9a4a0111952955644edff5"
			;;
		armv7*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_armhf.deb"
			checksum="ec11166c152646e236511d883617bc84a50843bce95385349f553dbfd4644862"
			;;
		aarch64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_arm64.deb"
			checksum="20564eed2bb36d21572bc4bbb4025c56f0f0227ae53ce8fdeb1febd7db1c4f49"
			;;
esac

nopie="yes"
nopie_files="/usr/lib/plexmediaserver/Plex DLNA Server"

make_dirs="/var/plexmediaserver 0755 _plex _plex"

do_extract() {
	fn="${distfiles##*/}"
	ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/${fn}"
	tar xf data.tar.xz
	mkdir -p etc/default usr/bin
	cp "${FILESDIR}/default" etc/default/plexmediaserver
	cp "${FILESDIR}/start_pms" usr/bin/start_pms
}

do_install() {
	vcopy etc /
	vcopy usr /
	vsv plex-media-server
	vlicense "${FILESDIR}/LICENSE"
}
