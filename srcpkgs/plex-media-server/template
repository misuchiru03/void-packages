# Template file for 'plex-media-server'
pkgname=plex-media-server
version=1.40.0.7775
revision=1
_suffix=456fbaf97
archs="i686 x86_64 armv7 aarch64"
create_wrksrc=yes
hostmakedepends="tar xz"
depends="glibc libssl1.1 libcrypto1.1 libswresample libavutil libva gtest libswscale
 libavformat libdrm libpciaccess fmt libavfilter taglib miniupnpc editline libusb"
short_desc="Plex Media Server"
maintainer="Anachron <gith@cron.world>"
license="custom:Proprietary"
homepage="https://www.plex.tv/media-server-downloads"
restricted=yes
repository=nonfree
system_accounts="_plex"
python_version=2
# libc.so contained here resolves in common/shlibs to musl-1.1.24_7
noverifyrdeps=yes
# See https://support.plex.tv/articles/categories/plex-media-server/

case "$XBPS_TARGET_MACHINE" in
		i686*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_i386.deb"
			checksum="ab48fe43debdc3e338378884c46250910b0cbb95968a89461b72213adf7507bc"
			;;
		x86_64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_amd64.deb"
			checksum="669f4cf73feedbed34f8a6364c339e2785d65f9020dca6ab6af3599905177f7e"
			;;
		armv7*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_armhf.deb"
			checksum="b464c268da9c99c5a02224830c164a6d4f3047ebdec94db07da2db5a40094caa"
			;;
		aarch64*)
			distfiles="https://downloads.plex.tv/${pkgname}-new/${version}-${_suffix}/debian/plexmediaserver_${version}-${_suffix}_arm64.deb"
			checksum="90e792f9d1db93c9cee5246006aa160e13c23c48cf580ac57dbf3033b0b58a2b"
			;;
esac

nopie="yes"
nopie_files="/usr/lib/plexmediaserver/Plex DLNA Server"

make_dirs="/var/plexmediaserver 0755 _plex _plex"

do_extract() {
	fn="${distfiles##*/}"
	ar x "${XBPS_SRCDISTDIR}/${pkgname}-${version}/${fn}"
	tar xf data.tar.xz
	mkdir -p etc/default usr/bin
	cp "${FILESDIR}/default" etc/default/plexmediaserver
	cp "${FILESDIR}/start_pms" usr/bin/start_pms
}

do_install() {
	vcopy etc /
	vcopy usr /
	vsv plex-media-server
	vlicense "${FILESDIR}/LICENSE"
}
